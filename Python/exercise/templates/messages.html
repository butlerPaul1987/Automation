{% extends "base.html" %}
{% block content %}
<div class="nav-tabs">
    <a href="{{ url_for('dashboard') }}" class="nav-tab">Dashboard</a>
    <a href="{{ url_for('messages') }}" class="nav-tab active">Messages</a>
</div>

<div class="card">
    <h3 class="card-header">Contact Coach</h3>
    <form method="POST" action="{{ url_for('send_message') }}">
        <div class="form-group">
            <label>To</label>
            <select name="recipient_id" required>
                {% if coach %}
                <option value="{{ coach.id }}">{{ coach.username }} (Your Coach)</option>
                {% endif %}
                {% if session.get('is_admin') %}
                {% for client in clients %}
                <option value="{{ client.id }}">{{ client.username }}</option>
                {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="form-group">
            <label>Subject</label>
            <input type="text" name="subject" required>
        </div>
        <div class="form-group">
            <label>Message</label>
            <textarea name="message" rows="4" required></textarea>
        </div>
        <button type="submit" class="btn btn-block">Send Message</button>
    </form>
</div>

<div class="card">
    <h3 class="card-header">Received Messages ({{ received_messages|length }})</h3>
    {% if received_messages %}
    {% for msg in received_messages %}
    <div class="workout-item" style="{% if not msg.is_read %}border-left-color:#d1312c;{% else %}border-left-color:#666;{% endif %}">
        <div class="workout-header">
            <div>
                <div style="{% if not msg.is_read %}font-weight:700;{% endif %}">{{ msg.subject }}</div>
                <div style="color:#999;font-size:.85em">From: {{ msg.sender.username }}</div>
            </div>
            <span class="workout-date">{{ msg.created_at.strftime('%d %b %Y, %H:%M') }}</span>
        </div>
        <div class="workout-notes">{{ msg.message }}</div>
        {% if not msg.is_read %}
        <form method="POST" action="{{ url_for('mark_message_read', message_id=msg.id) }}" style="margin-top:10px">
            <button type="submit" class="btn btn-small btn-secondary">Mark as Read</button>
        </form>
        {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <p>No messages received</p>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3 class="card-header">Sent Messages ({{ sent_messages|length }})</h3>
    {% if sent_messages %}
    {% for msg in sent_messages %}
    <div class="workout-item">
        <div class="workout-header">
            <div>
                <div>{{ msg.subject }}</div>
                <div style="color:#999;font-size:.85em">To: {{ msg.recipient.username }}</div>
            </div>
            <span class="workout-date">{{ msg.created_at.strftime('%d %b %Y, %H:%M') }}</span>
        </div>
        <div class="workout-notes">{{ msg.message }}</div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <p>No messages sent</p>
    </div>
    {% endif %}
</div>
{% endblock %}